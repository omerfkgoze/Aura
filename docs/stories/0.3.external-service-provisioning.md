# <!-- Powered by BMADâ„¢ Core -->

# Story 0.3: External Service Provisioning and Integration

## Status

**Approved**

## Story

**As a** project owner,  
**I want** all external service accounts created and configured with proper security settings,  
**so that** developers can integrate with production-ready infrastructure from day one.

## Acceptance Criteria

1. **Supabase Project Setup** (User Task)
   - Create new Supabase project: `https://app.supabase.com/new`
   - Configure project settings: enable Row Level Security by default
   - Generate service role key and anon key for development
   - Configure authentication providers (enable WebAuthn/Passkeys)
   - Set up database connection pooling and optimization settings

2. **Deployment Platform Setup** (User Task)
   - Create Vercel account and connect to GitHub repository
   - Configure Vercel project with environment variables
   - Set up staging and production environments
   - Configure custom domain (if applicable)

3. **Security and Monitoring Setup** (User Task)
   - Create Sentry account for error monitoring (privacy-safe configuration)
   - Configure Sentry projects for web, mobile, and API
   - Set up data scrubbing rules to prevent PII logging
   - Generate Sentry DSN keys for each environment

4. **Mobile App Store Preparation** (User Task)
   - Create Apple Developer account and App Store Connect entry
   - Create Google Play Console account and app entry
   - Generate signing certificates and store securely
   - Configure app store metadata and privacy policy links

5. **Service Integration Configuration**
   - Configure Supabase CLI with project credentials
   - Set up database migrations and RLS policies repository
   - Configure deployment pipelines with service credentials
   - Test service connectivity and authentication flows

## Tasks / Subtasks

- [ ] **Task 1: Supabase Setup Documentation and Validation** (AC: 1)
  - [ ] Create detailed Supabase setup guide with security checklist
  - [ ] Document required project settings: RLS enabled, WebAuthn configuration
  - [ ] Provide templates for service role and anon key environment variables
  - [ ] Create validation script to verify Supabase project configuration

- [ ] **Task 2: Vercel Platform Configuration** (AC: 2)
  - [ ] Create Vercel deployment configuration files (vercel.json)
  - [ ] Set up environment variable templates for staging and production
  - [ ] Configure build commands and deployment targets for all apps
  - [ ] Document custom domain setup process and SSL configuration

- [ ] **Task 3: Sentry Integration for Privacy-Safe Monitoring** (AC: 3)
  - [ ] Configure Sentry with data scrubbing rules preventing PII exposure
  - [ ] Create separate Sentry projects for web, mobile, and API components
  - [ ] Implement privacy-safe error tracking with zero health data logging
  - [ ] Set up performance monitoring without user data collection

- [ ] **Task 4: Mobile App Store Preparation Documentation** (AC: 4)
  - [ ] Create Apple Developer account setup guide with privacy policy requirements
  - [ ] Document Google Play Console setup with reproductive health app considerations
  - [ ] Provide signing certificate generation and secure storage procedures
  - [ ] Create app store metadata templates emphasizing privacy and security

- [ ] **Task 5: Service Integration and Connectivity Testing** (AC: 5)
  - [ ] Configure Supabase CLI with development and production project credentials
  - [ ] Set up database migration workflow using Supabase CLI commands
  - [ ] Create deployment pipeline configurations with secure credential management
  - [ ] Implement service connectivity tests for all external integrations

## Dev Notes

### Architecture Context

This story establishes the external service infrastructure required for the complete deployment pipeline described in [Source: architecture/deployment-architecture.md] and implements the service integration patterns defined in [Source: architecture/backend-architecture.md].

### Previous Story Insights

From Story 0.1 and 0.2 completion:

- Nx monorepo structure established with comprehensive build pipeline
- Development environment configured with local Supabase and Docker setup
- Environment variable validation implemented with Zod schemas
- Security headers and privacy-safe logging configured

### Key Technical Details

**Supabase Configuration** [Source: architecture/backend-architecture.md]

Critical Supabase settings for zero-knowledge architecture:

- **Row Level Security (RLS):** Must be enabled by default on all tables
- **WebAuthn Configuration:** Enable passkey authentication for hardware-backed security
- **Service Role Restrictions:** Service role limited to schema management, never user data access
- **Connection Pooling:** Configure for high availability with security-first settings
- **Database Firewall:** Restrict connections to authorized IP ranges only

**Deployment Pipeline Integration** [Source: architecture/deployment-architecture.md]

Required Vercel configuration for secure deployment:

```json
{
  "version": 2,
  "builds": [
    {
      "src": "apps/web/package.json",
      "use": "@vercel/next"
    }
  ],
  "env": {
    "NODE_ENV": "production",
    "SUPABASE_URL": "@supabase-url-prod",
    "SUPABASE_ANON_KEY": "@supabase-anon-key-prod"
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains"
        }
      ]
    }
  ]
}
```

**Privacy-Safe Monitoring** [Source: architecture/tech-stack.md]

Sentry configuration must prevent any health data exposure:

- **Data Scrubbing:** Enable all PII scrubbing rules automatically
- **Error Context Filtering:** Remove any user-identifiable information from error reports
- **Performance Monitoring:** Track technical metrics only, never user behavior
- **Session Replay:** Completely disabled for privacy protection

**Mobile App Store Requirements** [Source: architecture/deployment-architecture.md]

App store setup considerations for reproductive health app:

- **Privacy Policy:** Must explicitly address reproductive health data protection
- **Age Rating:** Appropriate rating for health and medical apps
- **Content Guidelines:** Compliance with health app guidelines for both platforms
- **Geographic Restrictions:** Consider regional availability based on legal requirements

**Environment Variables Structure** [Source: architecture/development-workflow.md]

Production environment variables required:

```bash
# Production Frontend
EXPO_PUBLIC_SUPABASE_URL=https://[project-id].supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=[anon-key]
EXPO_PUBLIC_API_URL=https://aura.app/api
EXPO_PUBLIC_SENTRY_DSN=[web-dsn]

# Production Backend
SUPABASE_URL=https://[project-id].supabase.co
SUPABASE_SERVICE_ROLE_KEY=[service-role-key]
DATABASE_URL=[supabase-db-url]
SENTRY_DSN=[api-dsn]
NEXTAUTH_SECRET=[production-secret]

# Shared Production
NODE_ENV=production
APP_VERSION=[release-version]
SECURITY_AUDIT_ENABLED=true
```

**File Locations** [Source: architecture/source-tree.md]

Service configuration files should be placed at:

- `infrastructure/supabase/config.toml` - Supabase CLI configuration
- `vercel.json` - Vercel deployment configuration
- `infrastructure/sentry/` - Sentry configuration files
- `docs/deployment-guide.md` - Service setup documentation
- `.github/workflows/deploy.yml` - CI/CD pipeline with service integration

**Security Considerations** [Source: architecture/coding-standards.md]

Critical security requirements for external services:

- **Zero-Knowledge Principle:** External services must never access plaintext health data
- **Token Management:** All service tokens must have appropriate scoping and expiration
- **Network Security:** All external communications must use certificate pinning
- **Audit Trail:** All service integrations must support audit logging
- **Emergency Controls:** Service configurations must support immediate access revocation

### Project Structure Alignment

External service configurations align with established monorepo structure:

- Infrastructure configurations in dedicated `infrastructure/` directory
- Deployment configurations at root level for platform recognition
- Documentation in `docs/` following established pattern
- CI/CD workflows in `.github/workflows/` with proper service integration

### Testing

**Testing Standards** [Source: architecture/tech-stack.md]

- **Service Integration Testing:** Validate connectivity and authentication for all external services
- **Configuration Testing:** Verify environment variables and service configurations
- **Security Testing:** Validate privacy and security settings for each service
- **Deployment Testing:** Test complete deployment pipeline from development to production
- **Monitoring Testing:** Verify error reporting and monitoring without PII exposure

**Test File Locations:**

- `apps/web/src/__tests__/service-integration.test.ts` - Service connectivity tests
- `scripts/__tests__/deployment-validation.test.js` - Deployment configuration tests
- `infrastructure/__tests__/` - Infrastructure configuration validation tests

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-09-01 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD - Assigned to development agent

### Debug Log References

TBD - Will be populated during implementation

### Completion Notes List

TBD - Will be populated during implementation

### File List

TBD - Will be populated during implementation

## QA Results

TBD - Will be populated after QA review
