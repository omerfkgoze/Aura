# <!-- Powered by BMADâ„¢ Core -->

# Story 2.2: Menstrual Cycle Data Entry Interface

## Parent Epic

**Epic 2: Core Cycle Tracking & Predictions** - This story builds on the encrypted local database foundation (Story 2.1) by implementing intuitive data entry interfaces for period dates, flow intensity, and symptoms with immediate local storage, enabling users to quickly record health information without connectivity requirements.

## Status

**Draft**

## Story

**As a** user tracking my menstrual cycle,
**I want** intuitive data entry for period dates, flow intensity, and symptoms with immediate local storage,
**so that** I can quickly record my health information without connectivity requirements.

## Acceptance Criteria

1. Period start/end date entry with calendar interface and quick-select options
2. Flow intensity tracking (light, medium, heavy) with customizable scales
3. Symptom logging with pre-defined categories and custom symptom support
4. Immediate local storage with client-side encryption before database writing
5. Data validation preventing impossible dates or inconsistent entries
6. Batch entry support for historical data import and retroactive updates
7. Data entry audit trail maintaining modification history for accuracy tracking

## Tasks / Subtasks

- [ ] **Task 1: Calendar Interface for Period Dates** (AC: 1)
  - [ ] Create calendar component with period start/end date selection
  - [ ] Implement quick-select options (today, yesterday, custom date)
  - [ ] Add period duration validation and visual feedback
  - [ ] Integrate with existing stealth mode UI adaptations
  - [ ] Test calendar functionality across cultural presets
  - [ ] Implement accessibility features for date selection

- [ ] **Task 2: Flow Intensity Tracking System** (AC: 2)
  - [ ] Design flow intensity selector with light/medium/heavy options
  - [ ] Create customizable scale configuration for user preferences
  - [ ] Implement visual feedback for flow intensity selection
  - [ ] Add flow intensity change tracking during periods
  - [ ] Test flow tracking with different cultural UI themes
  - [ ] Create unit tests for flow intensity validation

- [ ] **Task 3: Symptom Logging Interface** (AC: 3)
  - [ ] Build pre-defined symptom categories (mood, physical, energy)
  - [ ] Implement custom symptom creation and management
  - [ ] Create symptom intensity/severity tracking
  - [ ] Add multi-select functionality for concurrent symptoms
  - [ ] Design symptom search and filtering capabilities
  - [ ] Test symptom logging with accessibility requirements

- [ ] **Task 4: Local Storage with Client-Side Encryption** (AC: 4)
  - [ ] Integrate with existing SQLite encrypted database infrastructure
  - [ ] Implement immediate data encryption before database writes
  - [ ] Create data persistence layer using EncryptedCycleData model
  - [ ] Add automatic data backup to encrypted local storage
  - [ ] Test encryption performance with real-time data entry
  - [ ] Validate AAD integration for data integrity

- [ ] **Task 5: Data Validation System** (AC: 5)
  - [ ] Implement date validation preventing impossible entries
  - [ ] Create consistency checks for period and symptom data
  - [ ] Add validation for flow intensity and duration logic
  - [ ] Build user-friendly error messaging system
  - [ ] Test validation with edge cases and boundary conditions
  - [ ] Create comprehensive validation test suite

- [ ] **Task 6: Batch Entry and Historical Import** (AC: 6)
  - [ ] Design batch data entry interface for multiple cycles
  - [ ] Implement historical data import functionality
  - [ ] Create retroactive update capabilities with conflict detection
  - [ ] Build data import validation and error handling
  - [ ] Add progress indicators for large data imports
  - [ ] Test batch operations with encrypted storage integration

- [ ] **Task 7: Data Entry Audit Trail** (AC: 7)
  - [ ] Implement modification history tracking for all entries
  - [ ] Create audit trail storage with encryption
  - [ ] Build audit log viewing interface for accuracy tracking
  - [ ] Add modification reversal capabilities
  - [ ] Test audit trail with concurrent data modifications
  - [ ] Ensure audit trail privacy and security compliance

## Dev Notes

### Previous Story Insights

- **Story 2.1**: Encrypted local database infrastructure ready with SQLCipher/Realm integration, EncryptedCycleData model defined, database integrity verification active, auto-lock and duress protection systems operational [Source: docs/stories/2.1.encrypted-local-database-implementation.md]
- **Key Infrastructure Available**: Database connection manager with pooling, encryption validator, realm encrypted database with schema definitions, comprehensive testing frameworks with 90%+ coverage [Source: docs/stories/2.1.encrypted-local-database-implementation.md]

### Data Models

- **EncryptedCycleData**: Enhanced with sync support including version, deviceId, syncedAt fields for immediate local storage with conflict resolution [Source: docs/architecture/data-models.md#encryptedcycledata-enhanced-with-sync-support]
- **CryptoEnvelope**: Standardized structure with version, algorithm, KDF params, salt, nonce, keyId, AAD for data integrity validation [Source: docs/architecture/data-models.md#cryptoenvelope-standardized]
- **EncryptedUserPrefs**: All user preferences including cultural presets and stealth mode settings stored as encrypted blob [Source: docs/architecture/data-models.md#encrypteduserprefs]

### API Specifications

- **Local Database Access**: React Native applications using SQLite/Realm integration for offline-first data entry functionality [Source: docs/architecture/tech-stack.md]
- **Crypto Core Integration**: All data encryption must utilize packages/crypto-core Rust/WASM implementations with proper AAD validation [Source: docs/architecture/coding-standards.md#crypto-operations]
- **Memory Safety Requirements**: All data entry operations must zeroize sensitive data after encryption and database writes [Source: docs/architecture/coding-standards.md#security-coding-standards]

### Component Specifications

- **Mobile Framework**: Expo/React Native 50.x provides cross-platform data entry with crypto library integration [Source: docs/architecture/tech-stack.md]
- **UI Components**: Tamagui design system provides single cross-platform components with stealth mode adaptations [Source: docs/architecture/tech-stack.md]
- **State Management**: Zustand + TanStack Query separates UI state from server sync for immediate local data persistence [Source: docs/architecture/tech-stack.md]
- **Calendar Interface**: Must support cultural adaptations and stealth mode transitions [Source: docs/architecture/frontend-architecture.md]

### File Locations

- **Mobile App**: `apps/mobile/src/` contains React Native application with data entry components [Source: docs/architecture/source-tree.md]
- **UI Components**: `apps/mobile/src/components/` for data entry interfaces with stealth mode support [Source: docs/architecture/source-tree.md]
- **Crypto Core**: `packages/crypto-core/src/` provides Rust crypto library with WASM bindings for client-side encryption [Source: docs/architecture/source-tree.md]
- **Shared Types**: `packages/shared-types/src/` defines TypeScript types for encrypted cycle data models [Source: docs/architecture/source-tree.md]
- **Database Security**: `libs/database-security/src/` contains existing encrypted database infrastructure [Source: docs/stories/2.1.encrypted-local-database-implementation.md]

### Testing Requirements

- **Security Testing**: Data entry must validate proper encryption before database writes and no plaintext storage [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Cross-Platform Testing**: Validation across iOS, Android platforms with proper stealth mode functionality [Source: docs/architecture/tech-stack.md]
- **Accessibility Testing**: Calendar and data entry interfaces must meet WCAG AA 2.1 standards [Source: docs/architecture/frontend-architecture.md]
- **Performance Testing**: Real-time data entry and encryption operations within mobile device constraints [Story requirements]

### Technical Constraints

- **Zero-Knowledge Architecture**: Data entry must encrypt all health data before local storage, no plaintext persistence [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Memory Safety**: All data entry operations must properly zeroize sensitive data after encryption [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Offline-First Design**: Complete data entry functionality without network dependencies [Source: docs/architecture/tech-stack.md]
- **Cultural Adaptations**: Data entry interface must support cultural presets and stealth mode transitions [Source: docs/architecture/frontend-architecture.md]

## Testing

### Test File Locations

- **Unit Tests**: `apps/mobile/src/__tests__/data-entry/` for data entry component testing
- **Integration Tests**: `apps/mobile/src/__tests__/encryption/` for crypto integration with data entry
- **UI Tests**: `apps/mobile/src/__tests__/components/` for calendar and form component testing
- **Database Tests**: Utilize existing `libs/database-security/src/__tests__/` infrastructure

### Test Standards

- **React Native Testing**: Jest with React Native Testing Library for mobile data entry testing [Source: docs/architecture/tech-stack.md]
- **E2E Testing**: Playwright for cross-platform testing of data entry workflows [Source: docs/architecture/tech-stack.md]
- **Crypto Validation**: Comprehensive testing of data encryption before database storage [Source: docs/architecture/coding-standards.md#security-coding-standards]

### Testing Frameworks and Patterns

- **Component Testing**: Test data entry forms, calendar interface, and symptom logging components
- **Validation Testing**: Test data validation rules, error handling, and user feedback systems
- **Encryption Testing**: Test immediate encryption of data entry before local database writes
- **Accessibility Testing**: Test screen reader compatibility and keyboard navigation for data entry
- **Performance Testing**: Test real-time data entry performance and encryption speed

### Specific Testing Requirements

- **Calendar Testing**: Test date selection, period duration validation, and cultural adaptations
- **Flow Intensity Testing**: Test customizable scales, intensity tracking, and visual feedback
- **Symptom Logging Testing**: Test pre-defined categories, custom symptoms, and multi-select functionality
- **Encryption Testing**: Test client-side encryption before database writes with proper AAD validation
- **Validation Testing**: Test impossible date prevention, consistency checks, and error messaging
- **Batch Entry Testing**: Test historical import, retroactive updates, and conflict detection
- **Audit Trail Testing**: Test modification history, audit log viewing, and privacy compliance

## Change Log

| Date       | Version | Description                                     | Author       |
| ---------- | ------- | ----------------------------------------------- | ------------ |
| 2025-09-14 | 1.0     | Initial story creation for data entry interface | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent_
