# <!-- Powered by BMADâ„¢ Core -->

# Story 1.4: Device-Specific Key Management Infrastructure

## Parent Epic

**Epic 1: Foundation & Privacy Infrastructure** - Device-specific key management infrastructure implements Epic 1, Story 1.4 requirements for per-device encryption keys with device-class specific Argon2id tuning, enabling cryptographic isolation with optimal performance while building on the crypto core foundation (Story 1.2) and authentication system (Story 1.3).

## Status

**Draft**

## Story

**As a** crypto systems architect,
**I want** per-device encryption keys with device-class specific Argon2id tuning,
**so that** each device maintains independent cryptographic isolation with optimal performance.

## Acceptance Criteria

1. **Per-Device Master Key Generation and Storage**
   - Per-device master keys generated and stored in hardware-backed secure storage
   - Integration with iOS Keychain and Android Keystore/StrongBox
   - Secure key generation using platform-specific entropy sources
   - Hardware security module integration where available

2. **Device-Class Specific Argon2id Parameter Auto-Tuning**
   - Argon2id parameter auto-tuning based on device capabilities (64-256 MB memory, t=2-3)
   - Performance benchmarking during setup ensuring optimal user experience
   - Device capability detection and classification system
   - Adaptive parameter selection based on available system resources

3. **Hierarchical Key Derivation and Data Category Isolation**
   - Key derivation hierarchy enabling data category isolation and key rotation
   - BIP32-style hierarchical deterministic key derivation
   - Purpose-specific key derivation for different data categories
   - Forward secrecy implementation for key rotation scenarios

4. **Multi-Device Key Exchange Protocol**
   - Device registration and key exchange protocol for multi-device access
   - Secure device pairing without exposing master keys
   - Cross-device authentication and trust establishment
   - Device revocation and re-enrollment capabilities

5. **Key Backup and Recovery Integration**
   - Key backup and recovery system integrated with Passkeys authentication
   - Recovery phrase-based key restoration (BIP39 compatibility)
   - Secure key escrow with user-controlled recovery options
   - Emergency key recovery procedures with proper validation

6. **Key Rotation Framework Foundation**
   - Key rotation skeleton framework with versioned key management
   - Backward-compatible key version support
   - Progressive key migration support infrastructure
   - Key lifecycle management with automated rotation scheduling

7. **Performance and Security Validation**
   - Performance benchmarking during setup ensuring optimal user experience
   - Security audit preparation with comprehensive test coverage
   - Cryptographic operation timing validation
   - Memory usage optimization and validation

## Tasks / Subtasks

- [ ] **Task 1: Device Capability Detection and Classification System** (AC: 2)
  - [ ] Implement device hardware capability detection (CPU, RAM, secure enclave)
  - [ ] Create device classification system (mobile-high, mobile-low, web-standard, web-limited)
  - [ ] Build Argon2id parameter optimization matrix based on device class
  - [ ] Implement performance benchmarking system for KDF parameter tuning
  - [ ] Create adaptive parameter selection algorithm

- [ ] **Task 2: Platform-Specific Secure Storage Integration** (AC: 1)
  - [ ] Implement iOS Keychain integration for master key storage
  - [ ] Implement Android Keystore/StrongBox integration for hardware-backed storage
  - [ ] Create web-based secure storage using WebCrypto API and IndexedDB
  - [ ] Implement platform-specific entropy gathering for key generation
  - [ ] Add hardware security module detection and integration

- [ ] **Task 3: Hierarchical Key Derivation System** (AC: 3)
  - [ ] Design and implement BIP32-style HD key derivation structure
  - [ ] Create purpose-specific derivation paths for data categories
  - [ ] Implement key isolation for cycle data, preferences, and sharing
  - [ ] Add forward secrecy support for key rotation scenarios
  - [ ] Create key derivation documentation and validation tests

- [ ] **Task 4: Multi-Device Key Exchange Protocol** (AC: 4)
  - [ ] Design secure device pairing protocol without key exposure
  - [ ] Implement device registration and trust establishment system
  - [ ] Create cross-device authentication flow
  - [ ] Build device revocation and re-enrollment capabilities
  - [ ] Add device synchronization status tracking

- [ ] **Task 5: Recovery and Backup System Integration** (AC: 5)
  - [ ] Integrate with Passkeys authentication for key recovery initiation
  - [ ] Implement BIP39-compatible recovery phrase generation and validation
  - [ ] Create secure key escrow system with user-controlled access
  - [ ] Build emergency recovery procedures with multi-factor validation
  - [ ] Add recovery testing and validation framework

- [ ] **Task 6: Key Rotation Framework Foundation** (AC: 6)
  - [ ] Design versioned key management system
  - [ ] Implement backward-compatible key version support
  - [ ] Create progressive key migration infrastructure
  - [ ] Build automated rotation scheduling system
  - [ ] Add key lifecycle management and audit trail

- [ ] **Task 7: Integration with Crypto Core and Testing** (AC: 7)
  - [ ] Integrate with existing Rust/WASM crypto core (Story 1.2 dependency)
  - [ ] Implement comprehensive unit and integration tests
  - [ ] Create performance benchmarking and validation suite
  - [ ] Add memory usage optimization and monitoring
  - [ ] Prepare security audit documentation and test coverage

## Dev Notes

### Previous Story Insights

- **Story 1.1**: Database infrastructure provides DeviceKey table for secure key management with proper RLS policies [Source: docs/stories/1.1.database-infrastructure-and-security-setup.md]
- **Story 1.2**: Rust/WASM crypto core provides memory-safe cryptographic operations with auto-generated TypeScript bindings [Source: docs/stories/1.2.rust-wasm-crypto-core-implementation.md]
- **Story 1.3**: Passkeys + OPAQUE authentication system provides hardware-backed authentication foundation for key recovery [Source: docs/stories/1.3.passkeys-opaque-authentication-system.md]

### Data Models

- **DeviceKey Table Structure**: `id, userId, deviceIdHash, encryptedMasterKey, keyDerivationPath, keyVersion, nextRotationAt, status, platform, appVersion, lastActiveAt, createdAt` [Source: docs/architecture/data-models.md#devicekey-secure-key-management]
- **CryptoEnvelope Format**: Standardized envelope with version, algorithm, kdfParams, salt, nonce, keyId, and AAD for integrity [Source: docs/architecture/data-models.md#cryptoenvelope-standardized]

### Component Specifications

- **Frontend Crypto Core (Rust/WASM)**: Provides `generateMasterKey(recoveryPhrase): MasterKey`, `deriveDeviceKey(masterKey, deviceId, purpose): DeviceKey`, `rotateKeys(oldKey, newSalt): NewKeyPair` [Source: docs/architecture/components.md#frontend-crypto-core-rustwasm]
- **Authentication & Recovery Manager**: Provides device key management interfaces and multi-device authentication [Source: docs/architecture/components.md#authentication-recovery-manager]

### File Locations

- **Crypto Core Package**: `packages/crypto-core/src/keys.rs` for key management implementation [Source: docs/architecture/source-tree.md]
- **Mobile App Integration**: `apps/mobile/src/crypto/` for Rust/WASM crypto bindings [Source: docs/architecture/source-tree.md]
- **Shared Types**: `packages/shared-types/src/crypto.ts` for crypto-related type definitions [Source: docs/architecture/source-tree.md]
- **Database Migrations**: `db/migrations/` for DeviceKey table schema and policies [Source: docs/architecture/source-tree.md]

### Technical Constraints

- **Platform Requirements**: iOS Keychain, Android StrongBox, WebCrypto API support [Source: docs/architecture/tech-stack.md]
- **Memory Safety**: All crypto operations must zeroize sensitive data after use [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Device Privacy**: Device fingerprinting must use salted hashes with user-specific salts [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Performance**: Argon2id parameters must be optimized for device capabilities (64-256 MB memory, t=2-3) [Epic requirements]

### Testing

- **Testing Standards**: Unit tests with Vitest, integration tests with Testing Library [Source: docs/architecture/tech-stack.md]
- **Performance Testing**: Benchmarking during setup ensuring optimal user experience [Epic requirements]
- **Security Testing**: Property-based testing for all cryptographic operations [Story 1.2 foundation]
- **Cross-Platform Testing**: Validate key operations across iOS, Android, and web platforms [Source: docs/architecture/tech-stack.md]

## Change Log

| Date       | Version | Description                                               | Author       |
| ---------- | ------- | --------------------------------------------------------- | ------------ |
| 2025-01-15 | 1.0     | Initial story creation for device-specific key management | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here after story implementation_
