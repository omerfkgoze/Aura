# <!-- Powered by BMAD™ Core -->

# Story 0.4: Rust/WASM Build Pipeline Integration

## Status

**Ready**

## Story

**As a** developer implementing cryptographic features,  
**I want** a fully configured Rust/WASM build pipeline integrated into the monorepo,  
**so that** cryptographic operations are compiled and available for TypeScript consumption.

## Acceptance Criteria

1. **Rust Project Structure**
   - Create `libs/crypto-core` directory with Cargo workspace
   - Configure `Cargo.toml` with WebAssembly target and dependencies:
     - `getrandom = { version = "0.2", features = ["js"] }`
     - `wasm-bindgen = "0.2"`
     - `libsodium-sys` for crypto operations
   - Set up proper memory management with `wee_alloc`

2. **WASM Build Configuration**
   - Install `wasm-pack`: `curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh`
   - Configure build targets in `package.json`: `bundler`, `web`, `nodejs`
   - Set up TypeScript definitions generation: `wasm-bindgen` with `--typescript`
   - Configure build optimization: `wasm-opt -O3` for production builds
   - Add build scripts: `"build:wasm": "wasm-pack build --target bundler --out-dir pkg"`

3. **Nx Integration**
   - Create `libs/crypto-core/project.json` with custom executor:

   ```json
   {
     "targets": {
       "build": {
         "executor": "@nx/js:tsc",
         "dependsOn": ["build-wasm"]
       },
       "build-wasm": {
         "executor": "nx:run-commands",
         "options": {
           "command": "wasm-pack build --target bundler",
           "cwd": "libs/crypto-core"
         }
       }
     }
   }
   ```

   - Configure dependency graph: `apps/web` and `apps/mobile` depend on `crypto-core`
   - Set up watch mode: `nx run crypto-core:build-wasm --watch`
   - Integrate WASM build into main builds via `dependsOn` configuration

4. **Development Workflow**
   - Hot reload support for Rust changes during development
   - Source map generation for debugging WebAssembly
   - Automated testing of Rust code with `cargo test`
   - Integration testing of WASM bindings in TypeScript

5. **Security Configuration**
   - Configure `wasm-opt` for size and security optimization
   - Set up constant-time operation verification
   - Configure memory sanitization for development builds
   - Set up automated security audit of Rust dependencies

## Tasks / Subtasks

- [ ] **Task 1: Initialize Rust/WASM Project Structure** (AC: 1)
  - [ ] Create `libs/crypto-core` directory with proper Cargo workspace configuration
  - [ ] Set up `Cargo.toml` with WebAssembly-specific dependencies and crate configuration
  - [ ] Configure `wasm-bindgen` settings for TypeScript compatibility
  - [ ] Set up memory management with `wee_alloc` for optimized WASM builds
  - [ ] Create initial Rust crypto module structure (`lib.rs`, `envelope.rs`, `keys.rs`)

- [ ] **Task 2: Configure WASM Build System** (AC: 2)
  - [ ] Install and configure `wasm-pack` CLI tool in development environment
  - [ ] Set up build targets for multiple environments (bundler, web, nodejs)
  - [ ] Configure TypeScript definitions generation from Rust code
  - [ ] Set up `wasm-opt` optimization for production builds
  - [ ] Create package.json scripts for WASM compilation workflows

- [ ] **Task 3: Integrate with Nx Monorepo Build System** (AC: 3)
  - [ ] Create `project.json` with custom WASM build executor configuration
  - [ ] Set up dependency graph with proper build order (`crypto-core` → `web`/`mobile`)
  - [ ] Configure watch mode for development with automatic WASM recompilation
  - [ ] Integrate WASM build into main Nx build pipeline with caching support
  - [ ] Test build orchestration and dependency resolution

- [ ] **Task 4: Development Workflow and Debugging Setup** (AC: 4)
  - [ ] Configure hot reload support for Rust code changes in development
  - [ ] Set up source map generation for WebAssembly debugging
  - [ ] Create automated testing workflow for Rust code (`cargo test`)
  - [ ] Implement integration tests for WASM bindings in TypeScript
  - [ ] Document development workflow and debugging procedures

- [ ] **Task 5: Security and Performance Configuration** (AC: 5)
  - [ ] Configure `wasm-opt` with security-focused optimization flags
  - [ ] Set up constant-time operation verification for crypto functions
  - [ ] Configure memory sanitization and leak detection for development
  - [ ] Implement automated security audit workflow for Rust dependencies
  - [ ] Document security requirements and validation procedures

## Dev Notes

### Architecture Context

This story implements the Rust/WASM crypto core described in [Source: architecture/tech-stack.md] and establishes the secure cryptographic foundation required by the zero-knowledge architecture defined in [Source: architecture/coding-standards.md].

### Previous Story Insights

From Stories 0.1, 0.2, and 0.3 completion:

- **Nx Monorepo Structure**: Established with comprehensive build system and dependency management
- **TypeScript Configuration**: Strict mode configured across all packages with path mapping to `libs/*`
- **Development Environment**: Local setup with environment validation and Docker configurations
- **External Services**: Supabase, Vercel, and Sentry configured with production-ready security settings
- **Build System Challenges**: Previous stories revealed Nx cache issues and PNPM dependency conflicts that were resolved
- **Testing Infrastructure**: Vitest testing framework established across all packages

Key Lessons:

- Nx build dependency ordering is critical for monorepo success
- PNPM workspace configuration requires careful attention to hoisting and caching
- Environment variable validation with Zod prevents many runtime issues
- Security configurations must be tested, not just implemented

### Key Technical Details

**Crypto Core Requirements** [Source: architecture/tech-stack.md]

The Rust/WASM crypto core is designated as "CRITICAL: Client-side encryption only" and must implement:

- Zero-knowledge cryptographic operations
- Client-side encryption/decryption only (server never sees plaintext)
- Bulletproof crypto implementation using battle-tested libraries
- Memory safety with automatic zeroization of sensitive data

**Required Cargo Dependencies** [Source: architecture/coding-standards.md]

Essential dependencies for security-compliant crypto operations:

```toml
[dependencies]
getrandom = { version = "0.2", features = ["js"] }  # Secure randomness for browser
wasm-bindgen = "0.2"                                # JavaScript bindings
libsodium-sys = "0.2"                              # Crypto primitives
wee_alloc = "0.4"                                  # Memory optimization
zeroize = "1.5"                                    # Memory safety
```

**File Locations** [Source: architecture/source-tree.md]

Rust crypto core structure should follow established patterns:

```
libs/crypto-core/
├── src/
│   ├── lib.rs          # Main Rust crypto library
│   ├── aad.rs          # AAD validation logic
│   ├── keys.rs         # Key management
│   └── envelope.rs     # Crypto envelope handling
├── pkg/                # Generated WASM bindings
├── Cargo.toml          # Rust dependencies and configuration
└── project.json        # Nx build configuration
```

**TypeScript Integration** [Source: architecture/coding-standards.md]

Generated WASM bindings must follow type sharing rules:

- All crypto types defined in `libs/shared-types/src/crypto.ts`
- WASM functions imported through `@aura/crypto-core` package
- All crypto operations must go through `libs/crypto-core` (never direct crypto calls)

**Development Workflow Integration** [Source: architecture/development-workflow.md]

Build commands must work with established development workflow:

```bash
# Build crypto core (prerequisite for all other builds)
pnpm nx build crypto-core

# This command must work after WASM integration
pnpm nx run-many --target=dev --all

# Security validation must include Rust dependency audit
pnpm nx run-many --target=security-check --all
```

**Nx Build System Integration** [Source: architecture/source-tree.md]

The build system must support the established monorepo patterns:

- Build caching for WASM compilation (can be expensive)
- Dependency graph with `crypto-core` as prerequisite for `web` and `mobile`
- Watch mode support for development workflow
- Cross-platform build support (development on macOS, deployment on Linux)

**Security Requirements** [Source: architecture/coding-standards.md]

Critical security standards for crypto implementation:

- **Memory Safety**: All crypto operations must zeroize sensitive data after use
- **Constant-Time Operations**: Crypto functions must be resistant to timing attacks
- **AAD Validation**: All crypto operations must include Additional Authenticated Data
- **Zero-Knowledge Principle**: Crypto core must never expose plaintext data
- **Input Sanitization**: All inputs to crypto functions must be validated

**Mobile and Web Compatibility** [Source: architecture/tech-stack.md]

WASM build must work across all target platforms:

- **Web (Vite)**: Bundler target with proper ES module support
- **React Native (Metro)**: Node.js target with React Native specific bindings
- **Cross-platform**: Single codebase supporting both web and mobile deployment

### Project Structure Alignment

The crypto core structure aligns with established monorepo patterns:

- Package location in `libs/crypto-core` following shared library convention
- Nx project configuration following established patterns from other packages
- TypeScript integration following shared types pattern
- Build pipeline integration following established dependency patterns

### Testing

**Testing Standards** [Source: architecture/tech-stack.md]

- **Rust Testing**: Use `cargo test` for comprehensive unit testing of crypto functions
- **WASM Integration Testing**: Use Vitest for testing WASM bindings in TypeScript
- **Security Testing**: Implement property-based testing for crypto operations
- **Performance Testing**: Benchmark crypto operations for acceptable performance
- **Cross-platform Testing**: Validate WASM works correctly on both web and mobile

**Test File Locations**:

- `libs/crypto-core/src/` - Rust unit tests (following Rust conventions)
- `libs/crypto-core/__tests__/` - TypeScript integration tests for WASM bindings
- `libs/crypto-core/benches/` - Performance benchmarks for crypto operations

**Security Testing Requirements**:

- Constant-time verification for all crypto operations
- Memory leakage testing with development tools
- Fuzzing for input validation and edge cases
- Cross-compilation testing for build reproducibility

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-09-01 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

[To be filled by Dev Agent during implementation]

### Debug Log References

[To be filled by Dev Agent during implementation]

### Completion Notes List

[To be filled by Dev Agent during implementation]

### File List

[To be filled by Dev Agent during implementation]

## QA Results

[To be filled by QA Agent after story completion]
