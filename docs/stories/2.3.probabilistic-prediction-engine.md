# <!-- Powered by BMADâ„¢ Core -->

# Story 2.3: Probabilistic Prediction Engine

## Parent Epic

**Epic 2: Core Cycle Tracking & Predictions** - This story builds on the encrypted local database (Story 2.1) and data entry interface (Story 2.2) by implementing a Bayesian probabilistic prediction model with uncertainty quantification instead of false precision, enabling users to understand prediction reliability and make informed decisions.

## Status

**Approved**

## Story

**As a** user planning around my menstrual cycle,
**I want** probabilistic predictions with confidence intervals instead of false precision,
**so that** I understand the uncertainty in predictions and can make informed decisions.

## Acceptance Criteria

1. Bayesian prediction model incorporating cycle length variability and personal history
2. Confidence interval calculation for next period start with 50%, 80%, 95% bands
3. Ovulation prediction with uncertainty quantification based on available data
4. Prediction accuracy tracking with Brier score and negative log-likelihood metrics
5. "Decision regret" analysis helping users understand prediction reliability impact
6. Model uncertainty communication through visual probability distributions
7. Prediction calibration validation ensuring stated confidence matches actual accuracy

## Tasks / Subtasks

- [x] **Task 1: Bayesian Prediction Model Implementation** (AC: 1)
  - [x] Create base Bayesian model with cycle length variability modeling
  - [x] Implement personal history integration with weighted historical data
  - [x] Add cycle pattern recognition with seasonal variations
  - [x] Create model parameter estimation with Bayesian inference
  - [x] Implement adaptive learning from new cycle data
  - [x] Test Bayesian model with various cycle patterns and data completeness levels

- [x] **Task 2: Confidence Interval Calculation System** (AC: 2)
  - [x] Implement 50%, 80%, 95% confidence band calculations for period predictions
  - [x] Create statistical interval computation with proper uncertainty propagation
  - [x] Add confidence interval validation with historical data accuracy
  - [x] Implement interval width adjustment based on data quality and completeness
  - [x] Create confidence interval visualization components
  - [x] Test confidence intervals against actual period timing data

- [ ] **Task 3: Ovulation Prediction with Uncertainty** (AC: 3)
  - [ ] Implement ovulation timing prediction with cycle phase modeling
  - [ ] Create uncertainty quantification based on cycle regularity and available data
  - [ ] Add fertility window prediction with probability distributions
  - [ ] Implement ovulation prediction accuracy tracking and validation
  - [ ] Create ovulation uncertainty visualization components
  - [ ] Test ovulation predictions with various cycle lengths and patterns

- [ ] **Task 4: Prediction Accuracy Metrics System** (AC: 4)
  - [ ] Implement Brier score calculation for probabilistic prediction evaluation
  - [ ] Create negative log-likelihood metrics for prediction quality assessment
  - [ ] Add prediction accuracy history tracking with encrypted storage
  - [ ] Implement metrics comparison across different prediction models
  - [ ] Create accuracy metrics visualization and reporting
  - [ ] Test accuracy metrics with simulated and real cycle data

- [ ] **Task 5: Decision Regret Analysis Framework** (AC: 5)
  - [ ] Create decision regret calculation based on prediction reliability impact
  - [ ] Implement user decision outcome tracking with privacy preservation
  - [ ] Add regret analysis for different confidence levels and decision types
  - [ ] Create decision support recommendations based on regret analysis
  - [ ] Implement regret analysis reporting and insights
  - [ ] Test decision regret framework with user scenario simulations

- [ ] **Task 6: Model Uncertainty Communication** (AC: 6)
  - [ ] Create visual probability distribution components for prediction uncertainty
  - [ ] Implement uncertainty explanation system with contributing factors
  - [ ] Add interactive uncertainty exploration interfaces
  - [ ] Create uncertainty communication with user-friendly language
  - [ ] Implement uncertainty visualization with cultural adaptations and stealth mode
  - [ ] Test uncertainty communication effectiveness with user interface testing

- [ ] **Task 7: Prediction Calibration Validation** (AC: 7)
  - [ ] Implement calibration validation ensuring stated confidence matches actual accuracy
  - [ ] Create calibration metrics calculation and tracking
  - [ ] Add calibration curve visualization and analysis
  - [ ] Implement model recalibration based on validation results
  - [ ] Create calibration reporting and model improvement recommendations
  - [ ] Test calibration validation with extensive historical data and accuracy verification

## Dev Notes

### Previous Story Insights

- **Story 2.1**: Encrypted local database infrastructure with SQLCipher/Realm integration provides secure storage for prediction models and historical data [Source: docs/stories/2.1.encrypted-local-database-implementation.md]
- **Story 2.2**: Data entry interface provides comprehensive cycle data including period dates, flow intensity, and symptoms for prediction model input [Source: docs/stories/2.2.menstrual-cycle-data-entry-interface.md]
- **Key Infrastructure Available**: EncryptedCycleData model with sync support, client-side encryption with crypto-core integration, comprehensive data validation and audit trail systems [Source: docs/stories/2.1-2.2]

### Data Models

- **EncryptedCycleData**: Enhanced with sync support including version, deviceId, syncedAt fields providing historical cycle data for prediction models [Source: docs/architecture/data-models.md#encryptedcycledata-enhanced-with-sync-support]
- **ClientOnlyPredictionCache**: Predictions calculated and stored entirely on device with confidenceIntervals (p50, p80, p95), accuracy metrics (brierScore, calibration), never stored on server [Source: docs/architecture/data-models.md#clientonlypredictioncache]
- **CryptoEnvelope**: Standardized structure with AAD validation for prediction model data integrity and security [Source: docs/architecture/data-models.md#cryptoenvelope-standardized]

### API Specifications

- **Client-Side Processing**: All prediction calculations must occur on device using encrypted local data, no server-side processing of health information [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Crypto Core Integration**: Statistical computations and model data must utilize packages/crypto-core for secure memory operations [Source: docs/architecture/coding-standards.md#crypto-operations]
- **Local Database Access**: Prediction models access cycle data through encrypted local SQLite/Realm databases [Source: docs/architecture/tech-stack.md]

### Component Specifications

- **Prediction Engine (Client-Side)**: Menstrual cycle predictions with uncertainty quantification, confidence intervals, calibration metrics, explanation data [Source: docs/architecture/components.md#prediction-engine-client-side]
- **Mobile Framework**: Expo/React Native 50.x provides cross-platform prediction engine with statistical computation libraries [Source: docs/architecture/tech-stack.md]
- **UI Components**: Tamagui design system for uncertainty visualization with stealth mode adaptations [Source: docs/architecture/tech-stack.md]
- **State Management**: Zustand + TanStack Query for prediction cache and UI state management [Source: docs/architecture/tech-stack.md]

### File Locations

- **Mobile App**: `apps/mobile/src/` contains React Native application with prediction engine implementation [Source: docs/architecture/source-tree.md]
- **Prediction Engine**: `apps/mobile/src/components/prediction/` for prediction calculation components [Source: docs/architecture/source-tree.md]
- **Crypto Core**: `packages/crypto-core/src/` provides Rust crypto library for secure statistical operations [Source: docs/architecture/source-tree.md]
- **Shared Types**: `packages/shared-types/src/` defines TypeScript types for prediction models and confidence intervals [Source: docs/architecture/source-tree.md]
- **UI Components**: `packages/ui/src/` contains Tamagui components for uncertainty visualization [Source: docs/architecture/source-tree.md]

### Testing Requirements

- **Statistical Validation**: Prediction models must be validated with statistical accuracy metrics including Brier scores and calibration validation [Story requirements]
- **Cross-Platform Testing**: Validation across iOS, Android platforms with proper statistical computation accuracy [Source: docs/architecture/tech-stack.md]
- **Performance Testing**: Statistical computations must perform efficiently on mobile devices using Web Workers for heavy computation [Source: docs/architecture/components.md#prediction-engine-client-side]
- **Privacy Testing**: All prediction calculations must occur client-side with no health data exposure to external services [Source: docs/architecture/coding-standards.md#security-coding-standards]

### Technical Constraints

- **Client-Side Only**: All prediction calculations must occur on device, no server-side processing of health data [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Memory Safety**: All statistical operations must properly zeroize sensitive data after use [Source: docs/architecture/coding-standards.md#security-coding-standards]
- **Offline-First Design**: Complete prediction functionality without network dependencies [Source: docs/architecture/tech-stack.md]
- **Statistical Accuracy**: Prediction models must provide proper uncertainty quantification and calibration validation [Story requirements]

## Testing

### Test File Locations

- **Unit Tests**: `apps/mobile/src/__tests__/prediction/` for prediction engine component testing
- **Statistical Tests**: `apps/mobile/src/__tests__/statistics/` for statistical model validation and accuracy testing
- **Integration Tests**: `apps/mobile/src/__tests__/crypto-prediction/` for crypto integration with prediction calculations
- **UI Tests**: `apps/mobile/src/__tests__/visualization/` for uncertainty visualization component testing

### Test Standards

- **React Native Testing**: Jest with React Native Testing Library for mobile prediction engine testing [Source: docs/architecture/tech-stack.md]
- **Statistical Testing**: Comprehensive validation of Bayesian models, confidence intervals, and calibration metrics [Story requirements]
- **E2E Testing**: Playwright for cross-platform testing of prediction workflows and uncertainty visualization [Source: docs/architecture/tech-stack.md]
- **Performance Testing**: Web Workers testing for heavy statistical computation without UI blocking [Source: docs/architecture/components.md#prediction-engine-client-side]

### Testing Frameworks and Patterns

- **Prediction Model Testing**: Test Bayesian inference, confidence interval calculation, and uncertainty quantification
- **Accuracy Testing**: Test Brier score calculation, negative log-likelihood metrics, and calibration validation
- **Visualization Testing**: Test uncertainty bands, probability distributions, and interactive exploration interfaces
- **Privacy Testing**: Test client-side only calculations with no external data exposure
- **Performance Testing**: Test statistical computation performance and memory usage optimization

### Specific Testing Requirements

- **Bayesian Model Testing**: Test cycle length variability modeling, personal history integration, and adaptive learning
- **Confidence Interval Testing**: Test 50%, 80%, 95% band calculations with proper uncertainty propagation
- **Ovulation Prediction Testing**: Test timing predictions, fertility window calculations, and uncertainty quantification
- **Accuracy Metrics Testing**: Test Brier score and negative log-likelihood calculations with historical validation
- **Decision Regret Testing**: Test regret analysis framework and decision support recommendations
- **Uncertainty Communication Testing**: Test visual probability distributions and explanation systems
- **Calibration Testing**: Test calibration validation, metrics tracking, and model recalibration processes

## Change Log

| Date       | Version | Description                                  | Author       |
| ---------- | ------- | -------------------------------------------- | ------------ |
| 2025-09-15 | 1.0     | Initial story creation for prediction engine | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514) - BMad Dev Agent

### Debug Log References

No debugging issues encountered during Task 1 implementation.

### Completion Notes

**Task 1: Bayesian Prediction Model Implementation - COMPLETED**

- Successfully implemented comprehensive Bayesian prediction model with cycle length variability modeling
- Created adaptive learning engine for continuous model improvement based on prediction accuracy
- Implemented personal history integration with weighted historical data processing
- Added sophisticated cycle pattern recognition including seasonal variations and trend detection
- Created Bayesian inference system with proper prior/likelihood/posterior calculations
- Implemented comprehensive uncertainty quantification and confidence interval calculations
- Added complete test coverage with statistical validation and edge case handling
- All subtasks completed with proper TypeScript types and client-side privacy compliance

**Task 2: Confidence Interval Calculation System - COMPLETED**

- Successfully implemented comprehensive confidence interval calculator with 50%, 80%, 95% confidence bands
- Created advanced statistical interval computer with Monte Carlo simulation and bootstrap methods
- Implemented sophisticated uncertainty propagation system for combining multiple uncertainty sources
- Added interval validator with historical data validation, cross-validation, and temporal stability analysis
- Created dynamic interval adjuster based on data quality, accuracy history, and real-time factors
- Implemented interactive confidence interval visualization components with stealth mode support
- Added uncertainty explorer component for user education and factor analysis
- Created comprehensive test coverage with statistical validation and real-world scenarios
- All subtasks completed with proper biological constraints and privacy compliance

### File List

**New Files Created:**

- `libs/shared-types/src/prediction.ts` - Comprehensive prediction type definitions
- `apps/mobile/src/components/prediction/models/BayesianPredictionModel.ts` - Main Bayesian prediction engine
- `apps/mobile/src/components/prediction/models/AdaptiveLearningEngine.ts` - Adaptive learning system
- `apps/mobile/src/components/prediction/models/ConfidenceIntervalCalculator.ts` - Confidence interval calculation engine
- `apps/mobile/src/components/prediction/models/StatisticalIntervalComputer.ts` - Advanced statistical computation engine
- `apps/mobile/src/components/prediction/models/IntervalValidator.ts` - Historical data validation system
- `apps/mobile/src/components/prediction/models/IntervalAdjuster.ts` - Dynamic interval adjustment system
- `apps/mobile/src/components/prediction/visualization/ConfidenceIntervalChart.tsx` - Interactive confidence interval visualization
- `apps/mobile/src/components/prediction/visualization/UncertaintyExplorer.tsx` - Interactive uncertainty exploration component
- `apps/mobile/src/__tests__/prediction/BayesianPredictionModel.test.ts` - Unit tests for prediction model
- `apps/mobile/src/__tests__/prediction/AdaptiveLearningEngine.test.ts` - Unit tests for learning engine
- `apps/mobile/src/__tests__/prediction/ConfidenceIntervalCalculator.test.ts` - Unit tests for confidence intervals
- `apps/mobile/src/__tests__/prediction/IntervalValidator.test.ts` - Unit tests for interval validation

**Modified Files:**

- `libs/shared-types/src/index.ts` - Added prediction types export
- `docs/stories/2.3.probabilistic-prediction-engine.md` - Updated task completion status for Task 1 and Task 2

## QA Results

### Review Date

### Reviewed By
